{# templates/_task_date_form.html #}
<form
  hx-post="{{ url_for('edit_date', task_id=t.id) }}"
  hx-target="closest td"
  hx-swap="innerHTML"
  class="inline-flex items-center gap-2"
>
  {# --- Calendar mode --- #}
  <div id="date-picker-mode-{{ t.id }}" class="inline-flex items-center gap-2">
    <input
      type="date"
      name="due_date"
      value="{{ t.due_date.isoformat() if t.due_date else '' }}"
      class="border rounded px-2 py-1 text-sm"
      autofocus
      aria-label="Choose a due date from calendar"
      {# Optional: constrain range by uncommenting one/both lines below #}
      {# min="{{ (t.due_date or none) and t.due_date.isoformat() }}" #}
      {# max="{{ (t.due_date or none) and (t.due_date + namespace(delta=0).delta)|default('', true) }}" #}
    />

    <button type="submit" class="px-2 py-1 rounded text-sm bg-slate-800 text-white hover:bg-slate-700">
      Save
    </button>

    <button
      type="button"
      hx-get="{{ url_for('view_date', task_id=t.id) }}"
      hx-target="closest td"
      hx-swap="innerHTML"
      class="px-2 py-1 rounded text-sm border hover:bg-slate-50"
    >
      Cancel
    </button>

    <button
      type="button"
      hx-post="{{ url_for('edit_date', task_id=t.id) }}"
      hx-target="closest td"
      hx-swap="innerHTML"
      hx-vals='{"due_date": ""}'
      class="px-2 py-1 rounded text-sm border hover:bg-slate-50"
      title="Clear date"
    >
      Clear
    </button>

    <button
      type="button"
      class="px-2 py-1 rounded text-sm underline hover:no-underline"
      onclick="(function(id){ 
        document.getElementById('date-picker-mode-'+id).style.display='none';
        document.getElementById('date-text-mode-'+id).style.display='inline-flex';
        document.getElementById('date-text-input-'+id).focus();
      })({{ t.id }})"
      aria-label="Switch to text entry"
      title="Switch to text entry"
    >
      Use text
    </button>
  </div>

  {# --- Text mode (supports today, tomorrow, +3, 2025-11-01, etc.) --- #}
  <div id="date-text-mode-{{ t.id }}" class="hidden items-center gap-2">
    <input
      id="date-text-input-{{ t.id }}"
      type="text"
      name="due_date"
      value="{{ t.due_date.isoformat() if t.due_date else '' }}"
      placeholder="YYYY-MM-DD, today, tomorrow, +3, -2"
      class="border rounded px-2 py-1 text-sm w-56"
      autocomplete="off"
      aria-label="Enter a due date by text"
    />

    <button type="submit" class="px-2 py-1 rounded text-sm bg-slate-800 text-white hover:bg-slate-700">
      Save
    </button>

    <button
      type="button"
      hx-get="{{ url_for('view_date', task_id=t.id) }}"
      hx-target="closest td"
      hx-swap="innerHTML"
      class="px-2 py-1 rounded text-sm border hover:bg-slate-50"
    >
      Cancel
    </button>

    <button
      type="button"
      class="px-2 py-1 rounded text-sm underline hover:no-underline"
      onclick="(function(id){ 
        document.getElementById('date-text-mode-'+id).style.display='none';
        document.getElementById('date-picker-mode-'+id).style.display='inline-flex';
      })({{ t.id }})"
      aria-label="Switch to calendar picker"
      title="Switch to calendar picker"
    >
      Use calendar
    </button>
  </div>

  {% if error %}
    <span class="text-red-600 text-sm ml-1">{{ error }}</span>
  {% endif %}
</form>

<style>
  .hidden { display: none; }
</style>
